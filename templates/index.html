<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Instagram Monitoring Jadvali</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f8fafc;
            margin: 20px;
        }
        h2 {
            text-align: center;
            color: #1e293b;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #0f172a;
            color: white;
            position: relative;
            vertical-align: middle;
        }
        tr:nth-child(even) {
            background-color: #f1f5f9;
        }
        tr:hover {
            background-color: #e2e8f0;
        }
        a {
            color: #2563eb;
            text-decoration: none;
            font-weight: bold;
        }
        a:hover {
            text-decoration: underline;
        }
        /* Sort tugmalari */
        .sort-controls {
            display: inline-flex;
            flex-direction: column;
            gap: 2px;
            margin-left: 6px;
            vertical-align: middle;
        }
        .sort-btn {
            border: 1px solid rgba(255,255,255,0.35);
            background: rgba(255,255,255,0.12);
            color: #fff;
            font-weight: 700;
            line-height: 1;
            border-radius: 4px;
            padding: 0 4px;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
        }
        .sort-btn:hover { background: rgba(255,255,255,0.22); }
        .sort-btn:active { transform: translateY(1px); }
        .sorted-desc::after, .sorted-asc::after {
            content: "";
            display: inline-block;
            width: 6px; height: 6px;
            margin-left: 6px;
            border-radius: 50%;
            background: #22c55e;
        }
    </style>
</head>
<body>
    <h2>üìä Instagram Monitoring Jadvali</h2>
    <table id="monitoringTable">
        <thead>
            <tr>
                <th>‚Ññ</th>
                <th>Media ID</th>
                <th>Post Link</th>
                <th data-sortable="num">Views
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="num">Reach
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="num">Shares
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="num">Saved
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="num">+ Comments
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="num">Read DM
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="num">üõí Buy Clicks
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="num">‚ùå Bosmaganlar
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="num">üì© Aloqa Clicks
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
                <th data-sortable="percent">CTR (%)
                    <span class="sort-controls">
                        <button class="sort-btn" data-dir="desc">‚ñ≤</button>
                        <button class="sort-btn" data-dir="asc">‚ñº</button>
                    </span>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for row in monitoring_data %}
            <tr>
                <td>{{ row.num }}</td>
                <td>{{ row.media_id }}</td>
                <td><a href="{{ row.media_url }}" target="_blank">Link</a></td>
                <td>{{ row.views }}</td>
                <td class="reach">{{ row.reach }}</td>
                <td>{{ row.shares }}</td>
                <td>{{ row.saved }}</td>
                <td>{{ row.plus_comments }}</td>
                <td class="read_dm">{{ row.read_dm }}</td>
                <td class="buy_clicks">{{ row.buy_clicks }}</td>
                <td class="not_clicked">0</td>
                <td>{{ row.aloqa_clicks }}</td>
                <td class="ctr">0%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        function parseNumber(text) {
            const cleaned = (text || "").toString().replace(/[^0-9.\-]/g, "");
            const val = parseFloat(cleaned);
            return isNaN(val) ? 0 : val;
        }

        function computeDerivedColumns() {
            document.querySelectorAll("#monitoringTable tbody tr").forEach(row => {
                let read = parseNumber(row.querySelector(".read_dm")?.innerText);
                let buy = parseNumber(row.querySelector(".buy_clicks")?.innerText);
                let reach = parseNumber(row.querySelector(".reach")?.innerText);

                let diff = read - buy;
                if (diff < 0) diff = 0;
                row.querySelector(".not_clicked").innerText = diff.toString();

                let ctr = 0;
                if (reach > 0) {
                    ctr = (buy / reach) * 100;
                }
                row.querySelector(".ctr").innerText = ctr.toFixed(2) + "%";
            });
        }

        function sortTableByColumn(colIndex, direction, type) {
            const table = document.getElementById("monitoringTable");
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.querySelectorAll("tr"));

            const multiplier = direction === 'asc' ? 1 : -1;

            const sorted = rows.sort((a, b) => {
                const aText = a.children[colIndex]?.innerText || "";
                const bText = b.children[colIndex]?.innerText || "";
                let aVal, bVal;
                if (type === 'percent' || type === 'num') {
                    aVal = parseNumber(aText);
                    bVal = parseNumber(bText);
                } else {
                    aVal = aText.toLowerCase();
                    bVal = bText.toLowerCase();
                    return aVal.localeCompare(bVal) * multiplier;
                }
                if (aVal === bVal) return 0;
                return (aVal > bVal ? 1 : -1) * multiplier;
            });

            sorted.forEach(tr => tbody.appendChild(tr));
        }

        function setupSorting() {
            const headerRow = document.querySelector("#monitoringTable thead tr");
            const ths = Array.from(headerRow.children);

            ths.forEach((th, index) => {
                const sortableType = th.getAttribute('data-sortable');
                if (!sortableType) return;

                const controls = th.querySelectorAll('.sort-btn');
                controls.forEach(btn => {
                    const dir = btn.dataset.dir;
                    btn.addEventListener('click', () => {
                        headerRow.querySelectorAll('.sorted-asc, .sorted-desc').forEach(el => {
                            el.classList.remove('sorted-asc', 'sorted-desc');
                        });
                        th.classList.add(dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                        sortTableByColumn(index, dir, sortableType);
                    });
                });
            });
        }

        computeDerivedColumns();
        setupSorting();
    </script>
</body>
</html>
